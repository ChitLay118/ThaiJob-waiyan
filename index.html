<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>á€¡á€œá€¯á€•á€ºá€¡á€€á€­á€¯á€„á€º á€›á€¾á€¬á€–á€½á€±á€›á€±á€¸ á€¡á€€á€ºá€•á€º (Auth & Admin)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f6;
        }
        /* Custom scrollbar for better visibility */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <div id="app" class="flex-grow flex flex-col max-w-lg mx-auto w-full bg-white shadow-lg">

        <!-- Header -->
        <header class="bg-indigo-600 text-white p-4 shadow-md sticky top-0 z-10 flex justify-between items-center">
            <h1 class="text-xl font-bold">á€¡á€œá€¯á€•á€ºá€¡á€€á€­á€¯á€„á€º á€›á€¾á€¬á€–á€½á€±á€›á€±á€¸</h1>
            <button id="logout-btn" onclick="handleLogout()" class="text-sm px-3 py-1 bg-indigo-700 rounded-full hover:bg-indigo-800 transition duration-150 hidden">
                á€‘á€½á€€á€ºá€›á€”á€º
            </button>
        </header>
        <div id="user-info-bar" class="bg-indigo-500 text-white text-xs p-1 text-center hidden">
            <span id="user-email-display"></span>
            <span id="user-id-display" class="ml-2 opacity-70"></span>
        </div>

        <!-- Main Content Area -->
        <main id="content" class="flex-grow p-4 overflow-y-auto">
            <div class="flex justify-center items-center h-full">
                <div id="loading-spinner" class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
            </div>
        </main>

        <!-- Navigation Menu Bar -->
        <nav id="main-nav" class="bg-white border-t border-gray-200 sticky bottom-0 z-10 shadow-lg hidden">
            <div class="flex justify-around text-center text-xs">
                <button onclick="setView('home')" class="nav-item p-3 w-1/4 text-indigo-600 font-semibold border-t-2 border-indigo-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mx-auto mb-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                    á€™á€°á€œ
                </button>
                
                <!-- Notification Inbox Button -->
                <button onclick="setView('notifications')" class="nav-item p-3 w-1/4 text-gray-500 relative">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mx-auto mb-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
                    á€á€á€­á€•á€±á€¸á€á€»á€€á€º
                    <!-- Notification Badge (Shows if there are any notifications) -->
                    <span id="notification-badge" class="hidden absolute top-1 right-10 w-3 h-3 bg-red-500 rounded-full border-2 border-white"></span>
                </button>

                <button onclick="setView('profile')" class="nav-item p-3 w-1/4 text-gray-500">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mx-auto mb-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                    á€•á€›á€­á€¯á€–á€­á€¯á€„á€º
                </button>
                <button id="post-job-nav-btn" onclick="setView('post')" class="nav-item p-3 w-1/4 text-gray-500 hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mx-auto mb-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M12 18v-6"/><path d="M9 15h6"/></svg>
                    á€¡á€œá€¯á€•á€ºá€á€„á€ºá€›á€”á€º
                </button>
            </div>
        </nav>

    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, where, addDoc, updateDoc, getDocs, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONSTANTS ---
        const ADMIN_EMAIL = 'c388925@gmail.com';
        const CLOUDINARY_CLOUD_NAME = 'drizdw5nc';
        const CLOUDINARY_UPLOAD_PRESET = 'waiyansoe118234';

        // IMPORTANT: Global variables provided by the Canvas environment (prioritized)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        // Use user's provided config for Firebase initialization if global variable is not defined or is empty
        const userProvidedConfig = {
            apiKey: "AIzaSyAUL74mqVCIY1MMclrRhdVbY_VyP4lgQpY",
            authDomain: "waiappstore.firebaseapp.com",
            projectId: "waiappstore",
            storageBucket: "waiappstore.firebasestorage.app",
            messagingSenderId: "161610339691",
            appId: "1:161610339691:web:ce59fafb6a21729030682e",
            measurementId: "G-HH95X102MG"
        };
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : userProvidedConfig;


        let app;
        let db;
        let auth;
        let currentUserId = null;
        let currentUserEmail = null;
        let currentUserProfile = null; 
        let isAuthReady = false;
        let isUserAdmin = false;
        let pendingUsersList = []; 
        let myPostedJobsList = []; 
        
        // NEW: Cache for public contact info
        window.publicContactsCache = {};

        // State variables for selected files (for Cloudinary uploads)
        let selectedPassportFile = null;
        let selectedUserPhotoFile = null;
        let selectedJobImages = []; 
        let selectedJobVideo = null; 

        const contentDiv = document.getElementById('content');
        const loadingSpinner = document.getElementById('loading-spinner');
        const userIdDisplay = document.getElementById('user-id-display');
        const userEmailDisplay = document.getElementById('user-email-display');
        const postJobNavBtn = document.getElementById('post-job-nav-btn');
        const mainNav = document.getElementById('main-nav');
        const logoutBtn = document.getElementById('logout-btn');
        const userInfoBar = document.getElementById('user-info-bar');
        const notificationBadge = document.getElementById('notification-badge');

        // State
        let currentView = 'home';

        // Utility: Show/Hide Loading
        function showLoading() {
            contentDiv.innerHTML = '';
            loadingSpinner.classList.remove('hidden');
        }

        function hideLoading() {
            loadingSpinner.classList.add('hidden');
        }
        
        // Utility: Custom Console Log for Status/Errors
        function logStatus(message, isError = false) {
            console.log(`[${isError ? 'ERROR' : 'STATUS'}] ${message}`);
        }

        // Utility: Update Notification Badge
        function updateNotificationBadge() {
            if (window.notificationsList && window.notificationsList.length > 0) {
                notificationBadge.classList.remove('hidden');
            } else {
                notificationBadge.classList.add('hidden');
            }
        }

        // --- Cloudinary Upload Utility ---
        async function uploadToCloudinary(file) {
            if (!file) return null;

            const url = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/auto/upload`;
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    body: formData,
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Cloudinary upload failed: ${errorData.error.message}`);
                }

                const result = await response.json();
                return result.secure_url; // Return the secure URL
            } catch (error) {
                logStatus(`Cloudinary Upload Error: ${error.message}`, true);
                throw new Error('á€•á€¯á€¶ á€á€­á€¯á€·á€™á€Ÿá€¯á€á€º á€—á€®á€’á€®á€šá€­á€¯ á€á€„á€ºá€›á€¬á€á€½á€„á€º á€¡á€™á€¾á€¬á€¸á€–á€¼á€…á€ºá€•á€½á€¬á€¸á€•á€«á€á€Šá€ºá‹ Cloudinary Credentials á€€á€­á€¯ á€…á€…á€ºá€†á€±á€¸á€•á€«á‹');
            }
        }


        // --- Core Firebase Initialization and Authentication ---

        async function initFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                logStatus("Firebase Services Initialized.");

                onAuthStateChanged(auth, async (user) => {
                    isAuthReady = true;
                    if (user) {
                        currentUserId = user.uid;
                        currentUserEmail = user.email;
                        isUserAdmin = user.email === ADMIN_EMAIL;
                        
                        userInfoBar.classList.remove('hidden');
                        userEmailDisplay.textContent = `á€¡á€€á€±á€¬á€„á€·á€º: ${currentUserEmail}`;
                        userIdDisplay.textContent = `UID: ${currentUserId.substring(0, 8)}...`;
                        logoutBtn.classList.remove('hidden');
                        mainNav.classList.remove('hidden');

                        logStatus(`Authenticated: ${currentUserEmail} (Admin: ${isUserAdmin})`);
                        await setupFirestoreListeners();
                    } else {
                        currentUserId = null;
                        currentUserEmail = null;
                        currentUserProfile = null;
                        isUserAdmin = false;
                        
                        userInfoBar.classList.add('hidden');
                        logoutBtn.classList.add('hidden');
                        mainNav.classList.add('hidden');
                        
                        logStatus("No user signed in. Showing Login/Signup.");
                    }
                    renderCurrentView(); 
                });

            } catch (error) {
                logStatus(`Firebase Initialization Failed: ${error.message}`, true);
                hideLoading();
                contentDiv.innerHTML = '<p class="text-red-500 text-center">Firebase á€…á€á€„á€ºá€™á€¾á€¯ á€¡á€™á€¾á€¬á€¸á‹</p>';
            }
        }

        window.handleLogout = async function() {
            try {
                await signOut(auth);
                alertMessage('á€‘á€½á€€á€ºá€á€½á€¬á€á€¼á€„á€ºá€¸', 'á€á€„á€º á€¡á€±á€¬á€„á€ºá€™á€¼á€„á€ºá€…á€½á€¬ á€‘á€½á€€á€ºá€á€½á€¬á€á€²á€·á€•á€¼á€®á€¸á€•á€«á€•á€¼á€®á‹', 'info');
            } catch (error) {
                logStatus(`Logout Failed: ${error.message}`, true);
                alertMessage('á€¡á€™á€¾á€¬á€¸', `á€‘á€½á€€á€ºá€á€½á€¬á á€™á€›á€•á€«á‹: ${error.message}`, 'error');
            }
        }
        
        // --- Authentication Actions (No change) ---
        window.handleAuth = async function(event, isSignup) {
            event.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (password.length < 6) {
                return alertMessage('á€…á€€á€¬á€¸á€á€¾á€€á€º á€¡á€™á€¾á€¬á€¸', 'á€…á€€á€¬á€¸á€á€¾á€€á€ºá€á€Šá€º á€¡á€”á€Šá€ºá€¸á€†á€¯á€¶á€¸ á† á€œá€¯á€¶á€¸ á€›á€¾á€­á€›á€•á€«á€™á€šá€ºá‹', 'error');
            }

            try {
                if (isSignup) {
                    await createUserWithEmailAndPassword(auth, email, password);
                    alertMessage('á€¡á€€á€±á€¬á€„á€·á€ºá€–á€½á€„á€·á€ºá€á€¼á€„á€ºá€¸ á€¡á€±á€¬á€„á€ºá€™á€¼á€„á€º', 'á€¡á€€á€±á€¬á€„á€·á€ºá€–á€½á€„á€·á€ºá€á€¼á€„á€ºá€¸ á€¡á€±á€¬á€„á€ºá€™á€¼á€„á€ºá€•á€«á€á€Šá€ºá‹ á€€á€»á€±á€¸á€‡á€°á€¸á€•á€¼á€¯á á€á€„á€·á€ºá€•á€›á€­á€¯á€–á€­á€¯á€„á€ºá€€á€­á€¯ á€–á€¼á€Šá€·á€ºá€•á€«á‹', 'success');
                } else {
                    await signInWithEmailAndPassword(auth, email, password);
                    alertMessage('á€á€„á€ºá€›á€±á€¬á€€á€ºá€á€¼á€„á€ºá€¸ á€¡á€±á€¬á€„á€ºá€™á€¼á€„á€º', 'á€¡á€±á€¬á€„á€ºá€™á€¼á€„á€ºá€…á€½á€¬ á€á€„á€ºá€›á€±á€¬á€€á€ºá€á€²á€·á€•á€¼á€®á€¸á€•á€«á€•á€¼á€®á‹', 'success');
                }
            } catch (error) {
                let msg = error.message;
                if (error.code === 'auth/email-already-in-use') msg = 'á€¤á€¡á€®á€¸á€™á€±á€¸á€œá€ºá€–á€¼á€„á€·á€º á€¡á€€á€±á€¬á€„á€·á€ºá€–á€½á€„á€·á€ºá€‘á€¬á€¸á€•á€¼á€®á€¸á€á€¬á€¸á€•á€«á‹';
                if (error.code === 'auth/invalid-email') msg = 'á€¡á€®á€¸á€™á€±á€¸á€œá€ºá€•á€¯á€¶á€…á€¶ á€™á€™á€¾á€”á€ºá€•á€«á‹';
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') msg = 'á€¡á€®á€¸á€™á€±á€¸á€œá€º á€á€­á€¯á€·á€™á€Ÿá€¯á€á€º á€…á€€á€¬á€¸á€á€¾á€€á€º á€™á€¾á€¬á€¸á€šá€½á€„á€ºá€¸á€”á€±á€•á€«á€á€Šá€ºá‹';
                
                logStatus(`Auth Error: ${error.message}`, true);
                alertMessage('Auth á€¡á€™á€¾á€¬á€¸', msg, 'error');
            }
        }


        // --- Firestore Data Listeners (Updated to include Public Contacts) ---

        async function setupFirestoreListeners() {
            if (!currentUserId || !db) return;

            // 1. Listen for current user profile changes (Private)
            const userDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`);
            onSnapshot(userDocRef, (docSnap) => {
                currentUserProfile = docSnap.exists() ? docSnap.data() : null;
                logStatus(`User profile updated. Status: ${currentUserProfile ? currentUserProfile.status : 'N/A'}`);
                updateUIBasedOnProfile();
                renderCurrentView(); 
            }, (error) => {
                logStatus(`Profile Snapshot Error: ${error.message}`, true);
            });
            
            // 2. Listen for current user's posted jobs (for profile view)
            const myJobsColRef = collection(db, `artifacts/${appId}/public/data/jobs`);
            const myJobsQuery = query(myJobsColRef, where("postedBy", "==", currentUserId));
            onSnapshot(myJobsQuery, (snapshot) => {
                myPostedJobsList = [];
                snapshot.forEach(doc => {
                    myPostedJobsList.push({ id: doc.id, ...doc.data() });
                });
                myPostedJobsList.sort((a, b) => b.timestamp - a.timestamp); 
                logStatus(`Fetched ${myPostedJobsList.length} user-posted jobs.`);
                if (currentView === 'profile') {
                    renderRegistrationProfile(); 
                }
            }, (error) => {
                logStatus(`My Jobs Snapshot Error: ${error.message}`, true);
            });


            // 3. Listen for pending users (Admin only) 
            if (isUserAdmin) {
                const pendingColRef = collection(db, `artifacts/${appId}/public/data/pending_profiles`);
                onSnapshot(pendingColRef, (snapshot) => {
                    pendingUsersList = [];
                    snapshot.forEach(doc => {
                        pendingUsersList.push({ uid: doc.id, ...doc.data() });
                    });
                    logStatus(`Fetched ${pendingUsersList.length} pending users from public collection.`);
                    if (currentView === 'profile') {
                        renderAdminPanel(); 
                    }
                }, (error) => {
                    logStatus(`Admin Pending User Snapshot Error: ${error.message}`, true);
                });
            }


            // 4. Listen for all public job posts (Home view)
            const publicJobsCollectionRef = collection(db, `artifacts/${appId}/public/data/jobs`);
            const q = query(publicJobsCollectionRef); 

            logStatus("Starting public jobs listener...");

            onSnapshot(q, (snapshot) => {
                let jobsList = [];
                snapshot.forEach(doc => {
                    jobsList.push({ id: doc.id, ...doc.data() });
                });
                jobsList.sort((a, b) => b.timestamp - a.timestamp); 
                window.jobsList = jobsList; 
                logStatus(`Fetched ${jobsList.length} public jobs. Rerendering Home...`); 
                if (currentView === 'home') {
                    renderHome();
                }
            }, (error) => {
                logStatus(`Public Jobs Snapshot Error: ${error.message}`, true);
            });
            
            // 5. Listen for public notifications (All users)
            const notificationsColRef = collection(db, `artifacts/${appId}/public/data/notifications`);
            onSnapshot(notificationsColRef, (snapshot) => {
                window.notificationsList = [];
                snapshot.forEach(doc => {
                    window.notificationsList.push({ id: doc.id, ...doc.data() });
                });
                window.notificationsList.sort((a, b) => b.timestamp - a.timestamp); 
                logStatus(`Fetched ${window.notificationsList.length} public notifications.`);
                updateNotificationBadge();
                if (currentView === 'notifications') {
                    renderNotifications(); 
                }
            }, (error) => {
                logStatus(`Notifications Snapshot Error: ${error.message}`, true);
            });
            
            // 6. NEW: Listen for Public Contact Data (All users need this to show job poster info)
            const publicContactsColRef = collection(db, `artifacts/${appId}/public/data/public_contacts`);
            onSnapshot(publicContactsColRef, (snapshot) => {
                window.publicContactsCache = {};
                snapshot.forEach(doc => {
                    // Cache the public contact info using the UID as the key
                    window.publicContactsCache[doc.id] = doc.data(); 
                });
                logStatus(`Fetched ${Object.keys(window.publicContactsCache).length} public contact records.`);
            }, (error) => {
                logStatus(`Public Contacts Snapshot Error: ${error.message}`, true);
            });
        }

        // --- UI Update Logic (No change) ---

        function updateUIBasedOnProfile() {
            const isApproved = currentUserProfile && currentUserProfile.status === 'approved';
            
            // Highlight the active nav item
            document.querySelectorAll('.nav-item').forEach(btn => {
                btn.classList.remove('text-indigo-600', 'border-indigo-600', 'font-semibold');
                btn.classList.add('text-gray-500', 'border-t-2', 'border-transparent');
            });
            const activeBtn = document.querySelector(`.nav-item[onclick="setView('${currentView}')"]`);
            if (activeBtn) {
                activeBtn.classList.add('text-indigo-600', 'border-indigo-600', 'font-semibold');
                activeBtn.classList.remove('text-gray-500', 'border-transparent');
            }
            
            updateNotificationBadge(); // Update badge on every UI change

            // Show 'Post Job' button only if approved
            if (isApproved && !isUserAdmin) { 
                postJobNavBtn.classList.remove('hidden');
            } else {
                postJobNavBtn.classList.add('hidden');
            }
        }

        window.setView = function(view) {
            currentView = view;
            updateUIBasedOnProfile();
            renderCurrentView();
        }

        function renderCurrentView() {
            if (!isAuthReady) {
                showLoading();
                return;
            }
            if (!currentUserId) {
                renderLoginSignup();
                return;
            }
            
            hideLoading();
            
            try {
                if (isUserAdmin && currentView === 'profile') {
                    return renderAdminPanel();
                }

                if (currentView === 'post' && (!currentUserProfile || currentUserProfile.status !== 'approved')) {
                     logStatus("Tried to access Post View without approval. Redirecting to Profile.", true);
                     currentView = 'profile'; 
                }

                switch (currentView) {
                    case 'home':
                        renderHome();
                        break;
                    case 'profile':
                        renderRegistrationProfile();
                        break;
                    case 'post':
                        renderJobPostForm();
                        break;
                    case 'notifications':
                        renderNotifications();
                        break;
                    default:
                        renderHome();
                }
            } catch (error) {
                 logStatus(`Critical Error during View Render for ${currentView}: ${error.message}`, true);
                 contentDiv.innerHTML = `<div class="text-red-500 text-center p-8">á€™á€¼á€„á€ºá€€á€½á€„á€ºá€¸á€•á€¼á€›á€¬á€á€½á€„á€º á€¡á€›á€±á€¸á€€á€¼á€®á€¸á€á€±á€¬ á€¡á€™á€¾á€¬á€¸á€–á€¼á€…á€ºá€•á€½á€¬á€¸á€•á€«á€á€Šá€ºá‹ Console á€€á€­á€¯ á€…á€…á€ºá€†á€±á€¸á€•á€«á‹: ${error.message}</div>`;
            }
        }

        // --- View: Login/Signup (No change) ---
        function renderLoginSignup() {
            hideLoading();
            contentDiv.innerHTML = `
                <div class="max-w-md mx-auto mt-10 p-6 bg-white rounded-xl shadow-lg border border-gray-100">
                    <h2 class="text-2xl font-bold text-center text-indigo-700 mb-6">á€á€„á€ºá€›á€±á€¬á€€á€ºá€›á€”á€º/á€¡á€€á€±á€¬á€„á€·á€ºá€–á€½á€„á€·á€ºá€›á€”á€º</h2>
                    
                    <form id="auth-form" class="space-y-4">
                        <div>
                            <label for="email" class="block text-sm font-medium text-gray-700">á€¡á€®á€¸á€™á€±á€¸á€œá€º (Gmail)</label>
                            <input type="email" id="email" name="email" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 border p-2" placeholder="á€¥á€•á€™á€¬á‹ user@gmail.com">
                        </div>
                        <div>
                            <label for="password" class="block text-sm font-medium text-gray-700">á€…á€€á€¬á€¸á€á€¾á€€á€º</label>
                            <input type="password" id="password" name="password" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 border p-2" placeholder="á€¡á€”á€Šá€ºá€¸á€†á€¯á€¶á€¸ á† á€œá€¯á€¶á€¸">
                        </div>
                        <button type="button" onclick="handleAuth(event, false)" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 transition duration-150">
                            á€á€„á€ºá€›á€±á€¬á€€á€ºá€›á€”á€º (Login)
                        </button>
                        <p class="text-center text-gray-500 pt-2">á€¡á€€á€±á€¬á€„á€·á€ºá€™á€›á€¾á€­á€á€±á€¸á€˜á€°á€¸á€œá€¬á€¸?</p>
                        <button type="button" onclick="handleAuth(event, true)" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-indigo-600 border border-indigo-600 bg-white hover:bg-indigo-50 transition duration-150">
                            á€¡á€€á€±á€¬á€„á€·á€ºá€¡á€á€…á€ºá€–á€½á€„á€·á€ºá€›á€”á€º (Signup)
                        </button>
                    </form>
                </div>
            `;
        }

        // --- View 1: Home/Job Feed (Updated to call showJobPosterContacts) ---
        function renderHome() {
            contentDiv.innerHTML = '<h2 class="text-xl font-bold mb-4 text-gray-800">á€¡á€œá€¯á€•á€ºá€¡á€€á€­á€¯á€„á€ºá€™á€»á€¬á€¸</h2>';
            
            const jobsList = window.jobsList || [];

            if (jobsList.length === 0) {
                contentDiv.innerHTML += '<p class="text-center text-gray-500 mt-10">á€œá€€á€ºá€›á€¾á€­á€á€½á€„á€º á€á€½á€„á€·á€ºá€•á€¼á€¯á€‘á€¬á€¸á€á€±á€¬ á€¡á€œá€¯á€•á€ºá€™á€»á€¬á€¸ á€™á€›á€¾á€­á€á€±á€¸á€•á€«á‹</p>';
                return;
            }

            jobsList.forEach(job => {
                const images = job.media?.images || [];

                const imagePreviews = images.map((url, i) => `
                    <img src="${url}" onerror="this.onerror=null;this.src='https://placehold.co/100x64/9ca3af/ffffff?text=Image%20${i+1}'" alt="Job Image ${i+1}" class="w-full h-16 object-cover rounded-lg">
                `).join('') || '';
                
                const videoPreview = job.media?.video ? `<div class="bg-indigo-200 h-16 rounded-lg flex items-center justify-center text-xs text-indigo-700">Video (Link Available)</div>` : '';


                const jobCard = `
                    <div class="bg-gray-50 p-4 mb-4 rounded-xl shadow-sm border border-gray-100">
                        <h3 class="text-lg font-semibold text-indigo-700">${job.title || 'á€¡á€œá€¯á€•á€ºá€¡á€™á€Šá€ºá€™á€›á€¾á€­'}</h3>
                        <p class="text-sm text-gray-600 mt-1"><strong>ğŸ‘¤ á€á€„á€ºá€á€°:</strong> ${job.postedByName}</p>
                        <p class="text-sm text-gray-600"><strong>ğŸ“ á€á€Šá€ºá€”á€±á€›á€¬:</strong> ${job.location}</p>
                        <p class="text-sm text-gray-600"><strong>ğŸ’µ á€œá€…á€¬:</strong> ${job.salaryMin} - ${job.salaryMax} á€˜á€á€º</p>
                        <p class="text-sm text-gray-600 mb-2"><strong>ğŸ’¸ á€¡á€œá€¯á€•á€ºá€…á€™á€á€ºá€:</strong> ${job.smartFee || 0} á€˜á€á€º</p>
                        
                        ${job.description ? `<p class="text-gray-700 mt-2 whitespace-pre-wrap">${job.description.substring(0, 100)}${job.description.length > 100 ? '...' : ''}</p>` : ''}
                        
                        <div class="grid grid-cols-3 gap-2 mt-3">
                            ${imagePreviews}
                            ${videoPreview}
                        </div>

                        <button onclick="showJobPosterContacts('${job.postedBy}', '${job.postedByName}')" class="mt-3 w-full bg-indigo-500 text-white py-2 rounded-lg hover:bg-indigo-700 transition duration-150">
                            á€¡á€œá€¯á€•á€ºá€œá€»á€¾á€±á€¬á€€á€ºá€›á€”á€º/á€†á€€á€ºá€á€½á€šá€ºá€›á€”á€º
                        </button>
                    </div>
                `;
                contentDiv.innerHTML += jobCard;
            });
        }

        // NEW: Function to show poster's contact details
        window.showJobPosterContacts = function(posterId, posterName) {
            const contact = window.publicContactsCache[posterId];

            if (!contact) {
                return alertMessage('á€¡á€™á€¾á€¬á€¸', 'á€¡á€œá€¯á€•á€ºá€á€„á€ºá€á€°á á€†á€€á€ºá€á€½á€šá€ºá€›á€”á€º á€¡á€á€»á€€á€ºá€¡á€œá€€á€ºá€™á€»á€¬á€¸á€€á€­á€¯ á€›á€¾á€¬á€™á€á€½á€±á€·á€•á€«á‹', 'error');
            }

            const modalTitle = `${posterName} á á€†á€€á€ºá€á€½á€šá€ºá€›á€”á€º á€¡á€á€»á€€á€ºá€¡á€œá€€á€º`;
            const phone = contact.thaiPhoneNumber || 'á€™á€–á€±á€¬á€ºá€•á€¼á€‘á€¬á€¸á€•á€«';
            const fbLink = contact.facebookLink || '';
            const tgLink = contact.telegramLink || '';

            const content = `
                <div class="space-y-4">
                    <div class="p-3 bg-gray-50 rounded-lg">
                        <p class="text-sm font-semibold text-gray-700">ğŸ“ á€–á€¯á€”á€ºá€¸á€”á€¶á€•á€«á€á€º (á€‘á€­á€¯á€„á€ºá€¸):</p>
                        <p class="text-lg font-bold text-indigo-600">${phone}</p>
                    </div>
                    
                    <div class="p-3 bg-gray-50 rounded-lg">
                        <p class="text-sm font-semibold text-gray-700">ğŸ“˜ Facebook Link:</p>
                        ${fbLink 
                            ? `<a href="${fbLink}" target="_blank" class="text-blue-500 hover:text-blue-700 underline text-sm break-all">${fbLink.substring(0, 40)}...</a>`
                            : '<p class="text-gray-500 text-sm">á€™á€–á€±á€¬á€ºá€•á€¼á€‘á€¬á€¸á€•á€«</p>'}
                    </div>

                    <div class="p-3 bg-gray-50 rounded-lg">
                        <p class="text-sm font-semibold text-gray-700">ğŸ’¬ Telegram Link:</p>
                        ${tgLink 
                            ? `<a href="${tgLink}" target="_blank" class="text-blue-500 hover:text-blue-700 underline text-sm break-all">${tgLink.substring(0, 40)}...</a>`
                            : '<p class="text-gray-500 text-sm">á€™á€–á€±á€¬á€ºá€•á€¼á€‘á€¬á€¸á€•á€«</p>'}
                    </div>
                </div>
            `;
            
            showCustomModal(modalTitle, content, 'contact');
        }


        // --- View 2A: Registration/Profile (Updated for Approved User Edit Form) ---
        
        window.handleProfileFileChange = function(event, type) {
            const file = event.target.files[0];
            const statusElement = document.getElementById(`${type}-file-status`);
            if (file) {
                if (type === 'passport') {
                    selectedPassportFile = file;
                } else {
                    selectedUserPhotoFile = file;
                }
                statusElement.textContent = `á€›á€½á€±á€¸á€á€»á€šá€ºá€•á€¼á€®á€¸: ${file.name}`;
            } else {
                if (type === 'passport') {
                    selectedPassportFile = null;
                } else {
                    selectedUserPhotoFile = null;
                }
                statusElement.textContent = '';
            }
        }

        function renderRegistrationProfile() {
            const user = currentUserProfile;
            let statusBadge;
            let formContent;

            if (!user || !user.status || user.status === 'denied') {
                statusBadge = '<span class="px-3 py-1 bg-red-100 text-red-700 rounded-full font-medium">âŒ á€™á€¾á€á€ºá€•á€¯á€¶á€á€„á€ºá€›á€”á€º á€œá€­á€¯á€¡á€•á€ºá€á€Šá€º</span>';
                formContent = renderProfileSubmissionForm();
            } else if (user.status === 'pending') {
                statusBadge = '<span class="px-3 py-1 bg-yellow-100 text-yellow-700 rounded-full font-medium">â³ Admin á€á€½á€„á€·á€ºá€•á€¼á€¯á€á€»á€€á€º á€…á€±á€¬á€„á€·á€ºá€†á€­á€¯á€„á€ºá€¸á€”á€±á€•á€«á€á€Šá€º</span>';
                formContent = `
                    <p class="mt-4 text-center text-gray-600">á€á€„á€ºá á€¡á€á€»á€€á€ºá€¡á€œá€€á€ºá€™á€»á€¬á€¸ á€á€„á€ºá€á€½á€„á€ºá€¸á€•á€¼á€®á€¸á€•á€«á€•á€¼á€®á‹ Admin á€™á€¾ á€…á€…á€ºá€†á€±á€¸á€”á€±á€•á€«á€á€Šá€ºá‹</p>
                    <p class="text-xs text-center text-gray-400 mt-2">á€á€½á€„á€·á€ºá€•á€¼á€¯á€•á€¼á€®á€¸á€•á€«á€€ á€¡á€œá€¯á€•á€ºá€á€„á€ºá€á€½á€„á€·á€º á€›á€•á€«á€™á€Šá€ºá‹</p>
                `;
            } else { // approved
                statusBadge = '<span class="px-3 py-1 bg-green-100 text-green-700 rounded-full font-medium">âœ… á€¡á€œá€¯á€•á€ºá€á€„á€ºá€›á€”á€º á€á€½á€„á€·á€ºá€•á€¼á€¯á€•á€¼á€®á€¸</span>';
                
                // Show uploaded images if available
                const passportImg = user.passportPhotoUrl ? `<img src="${user.passportPhotoUrl}" onerror="this.onerror=null;this.src='https://placehold.co/100x64/9ca3af/ffffff?text=Passport%20Photo'" alt="Passport Photo" class="w-full h-20 object-cover rounded-lg">` : '<div class="h-20 flex items-center justify-center text-xs text-gray-500">á€•á€á€ºá€…á€•á€­á€¯á€· á€“á€¬á€á€ºá€•á€¯á€¶ á€™á€›á€¾á€­á€•á€«</div>';
                const userImg = user.userPhotoUrl ? `<img src="${user.userPhotoUrl}" onerror="this.onerror=null;this.src='https://placehold.co/100x64/9ca3af/ffffff?text=User%20Photo'" alt="User Photo" class="w-full h-20 object-cover rounded-lg">` : '<div class="h-20 flex items-center justify-center text-xs text-gray-500">á€œá€° á€“á€¬á€á€ºá€•á€¯á€¶ á€™á€›á€¾á€­á€•á€«</div>';


                formContent = `
                    <div class="space-y-4 mb-6 pb-4 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-800">á€€á€­á€¯á€šá€ºá€›á€±á€¸á€¡á€á€»á€€á€ºá€¡á€œá€€á€º (á€–á€á€ºá€›á€”á€ºá€á€¬)</h3>
                        <p class="text-gray-700"><strong>á€¡á€®á€¸á€™á€±á€¸á€œá€º:</strong> ${currentUserEmail}</p>
                        <p class="text-gray-700"><strong>á€”á€¬á€™á€Šá€º (Passport):</strong> ${user.passportName}</p>
                        <p class="text-gray-700"><strong>á€”á€±á€›á€•á€ºá€œá€­á€•á€ºá€…á€¬:</strong> ${user.address}</p>
                        <div class="grid grid-cols-2 gap-4 pt-2">
                            <div class="text-center bg-gray-200 p-3 rounded-lg text-sm">${passportImg}</div>
                            <div class="text-center bg-gray-200 p-3 rounded-lg text-sm">${userImg}</div>
                        </div>
                    </div>
                    
                    ${renderContactEditForm(user)}
                    ${renderMyPostedJobs()}
                `;
            }

            contentDiv.innerHTML = `
                <h2 class="text-xl font-bold mb-4 text-gray-800">á€•á€›á€­á€¯á€–á€­á€¯á€„á€º á€¡á€á€¼á€±á€¡á€”á€±</h2>
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">á€¡á€€á€±á€¬á€„á€·á€º á€¡á€á€¼á€±á€¡á€”á€±:</h3>
                        ${statusBadge}
                    </div>
                    ${formContent}
                </div>
            `;
        }
        
        // Helper function to render the initial profile submission form (Updated with links)
        function renderProfileSubmissionForm() {
            return `
                <p class="text-sm text-gray-600 mt-4 mb-4">á€¡á€œá€¯á€•á€ºá€á€„á€ºá€á€½á€„á€·á€ºá€›á€›á€¾á€­á€›á€”á€º á€¡á€±á€¬á€€á€ºá€•á€« á€¡á€á€»á€€á€ºá€¡á€œá€€á€ºá€™á€»á€¬á€¸á€€á€­á€¯ á€–á€¼á€Šá€·á€ºá€…á€½á€€á€ºá Admin á€‘á€¶ á€á€½á€„á€·á€ºá€•á€¼á€¯á€á€»á€€á€º á€á€„á€ºá€á€½á€„á€ºá€¸á€›á€•á€«á€™á€Šá€ºá‹</p>
                <form id="profile-form" class="space-y-4 mt-6" onsubmit="submitProfile(event)">
                    <!-- Passport Name -->
                    <div>
                        <label for="passport-name" class="block text-sm font-medium text-gray-700">á€”á€¬á€™á€Šá€º (á€•á€á€ºá€…á€•á€­á€¯á€·á€”á€¬á€™á€Šá€º)</label>
                        <input type="text" id="passport-name" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 border p-2" value="${currentUserProfile?.passportName || ''}">
                    </div>
                    <!-- Phone Number -->
                    <div>
                        <label for="phone-number" class="block text-sm font-medium text-gray-700">á€–á€¯á€”á€ºá€¸á€”á€¶á€•á€«á€á€º (á€‘á€­á€¯á€„á€ºá€¸ - á€†á€€á€ºá€á€½á€šá€ºá€›á€”á€º)</label>
                        <input type="tel" id="phone-number" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 border p-2" value="${currentUserProfile?.thaiPhoneNumber || ''}">
                    </div>
                    <!-- Facebook Link -->
                    <div>
                        <label for="facebook-link" class="block text-sm font-medium text-gray-700">Facebook Link (optional)</label>
                        <input type="url" id="facebook-link" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 border p-2" placeholder="https://www.facebook.com/..." value="${currentUserProfile?.facebookLink || ''}">
                    </div>
                    <!-- Telegram Link -->
                    <div>
                        <label for="telegram-link" class="block text-sm font-medium text-gray-700">Telegram Link (optional)</label>
                        <input type="url" id="telegram-link" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 border p-2" placeholder="https://t.me/username or @username" value="${currentUserProfile?.telegramLink || ''}">
                    </div>
                    <!-- Address -->
                    <div>
                        <label for="address" class="block text-sm font-medium text-gray-700">á€”á€±á€›á€•á€ºá€œá€­á€•á€ºá€…á€¬</label>
                        <textarea id="address" rows="2" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 border p-2">${currentUserProfile?.address || ''}</textarea>
                    </div>
                    <!-- Photo Uploads (Real Upload) -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="passport-file" class="block text-sm font-medium text-gray-700 mb-1">á€•á€á€ºá€…á€•á€­á€¯á€·á€“á€¬á€á€ºá€•á€¯á€¶</label>
                            <input type="file" id="passport-file" accept="image/*" required 
                                onchange="handleProfileFileChange(event, 'passport')" 
                                class="w-full text-sm text-gray-500 border border-gray-300 rounded-lg p-1">
                            <p id="passport-file-status" class="text-xs text-gray-500 mt-1 text-indigo-600"></p>
                        </div>
                        <div>
                            <label for="user-photo-file" class="block text-sm font-medium text-gray-700 mb-1">á€œá€° á€“á€¬á€á€ºá€•á€¯á€¶</label>
                            <input type="file" id="user-photo-file" accept="image/*" required 
                                onchange="handleProfileFileChange(event, 'user_photo')" 
                                class="w-full text-sm text-gray-500 border border-gray-300 rounded-lg p-1">
                            <p id="user-photo-file-status" class="text-xs text-gray-500 mt-1 text-indigo-600"></p>
                        </div>
                    </div>
                    <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 mt-4">
                        Admin á€á€½á€„á€·á€ºá€•á€¼á€¯á€á€»á€€á€ºá€¡á€á€½á€€á€º á€¡á€á€»á€€á€ºá€¡á€œá€€á€º á€•á€­á€¯á€·á€›á€”á€º
                    </button>
                </form>
            `;
        }
        
        // NEW: Helper function to render the contact edit form for approved users
        function renderContactEditForm(user) {
            return `
                <div class="space-y-4 mb-6 pt-4 border-t border-gray-200">
                    <h3 class="text-lg font-semibold text-indigo-700">á€†á€€á€ºá€á€½á€šá€ºá€›á€”á€º á€¡á€á€»á€€á€ºá€¡á€œá€€á€º á€•á€¼á€„á€ºá€†á€„á€ºá€›á€”á€º</h3>
                    <p class="text-sm text-gray-600">á€¤á€¡á€á€»á€€á€ºá€¡á€œá€€á€ºá€™á€»á€¬á€¸á€á€Šá€º á€á€„á€ºá€á€„á€ºá€á€±á€¬ á€¡á€œá€¯á€•á€ºá€™á€»á€¬á€¸á€á€½á€„á€º á€¡á€™á€»á€¬á€¸á€•á€¼á€Šá€ºá€á€°á€™á€¼á€„á€ºá€”á€­á€¯á€„á€ºá€™á€Šá€ºá€–á€¼á€…á€ºá€•á€«á€á€Šá€ºá‹</p>
                    <form id="contact-edit-form" class="space-y-4" onsubmit="updateContactInfo(event)">
                        <!-- Phone Number -->
                        <div>
                            <label for="edit-phone-number" class="block text-sm font-medium text-gray-700">á€–á€¯á€”á€ºá€¸á€”á€¶á€•á€«á€á€º (á€‘á€­á€¯á€„á€ºá€¸ - á€†á€€á€ºá€á€½á€šá€ºá€›á€”á€º)</label>
                            <input type="tel" id="edit-phone-number" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 border p-2" value="${user.thaiPhoneNumber || ''}">
                        </div>
                        <!-- Facebook Link -->
                        <div>
                            <label for="edit-facebook-link" class="block text-sm font-medium text-gray-700">Facebook Link (optional)</label>
                            <input type="url" id="edit-facebook-link" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 border p-2" placeholder="https://www.facebook.com/..." value="${user.facebookLink || ''}">
                        </div>
                        <!-- Telegram Link -->
                        <div>
                            <label for="edit-telegram-link" class="block text-sm font-medium text-gray-700">Telegram Link (optional)</label>
                            <input type="url" id="edit-telegram-link" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 border p-2" placeholder="https://t.me/username or @username" value="${user.telegramLink || ''}">
                        </div>
                        <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 mt-4">
                            á€¡á€á€»á€€á€ºá€¡á€œá€€á€º á€•á€¼á€„á€ºá€†á€„á€ºá€›á€”á€º
                        </button>
                    </form>
                </div>
            `;
        }

        // NEW: Function to handle updating contact info for approved users
        window.updateContactInfo = async function(event) {
            event.preventDefault();
            if (!currentUserId || !db) return alertMessage('á€¡á€™á€¾á€¬á€¸', 'á€…á€”á€…á€ºá€€á€­á€¯ á€…á€á€„á€ºá á€™á€›á€á€±á€¸á€•á€«á‹', 'error');

            const phoneNumber = document.getElementById('edit-phone-number').value.trim();
            const facebookLink = document.getElementById('edit-facebook-link').value.trim();
            const telegramLink = document.getElementById('edit-telegram-link').value.trim();

            if (!phoneNumber) {
                return alertMessage('á€¡á€™á€¾á€¬á€¸', 'á€–á€¯á€”á€ºá€¸á€”á€¶á€•á€«á€á€º á€–á€¼á€Šá€·á€ºá€á€½á€„á€ºá€¸á€›á€”á€º á€œá€­á€¯á€¡á€•á€ºá€•á€«á€á€Šá€ºá‹', 'error');
            }

            try {
                showLoading(); 
                
                const updateData = {
                    thaiPhoneNumber: phoneNumber,
                    facebookLink: facebookLink,
                    telegramLink: telegramLink,
                    lastUpdated: Date.now()
                };

                // 1. Update User's Private Profile (keeps all profile data)
                const userDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`);
                await updateDoc(userDocRef, updateData);
                
                // 2. Save/Update Public Contact Collection (for job seekers)
                const publicContactRef = doc(db, `artifacts/${appId}/public/data/public_contacts`, currentUserId); 
                await setDoc(publicContactRef, updateData, { merge: true }); // Use setDoc with merge to ensure creation if missing
                
                hideLoading();
                alertMessage('á€•á€¼á€„á€ºá€†á€„á€ºá€™á€¾á€¯ á€¡á€±á€¬á€„á€ºá€™á€¼á€„á€ºá€•á€«á€á€Šá€º', 'á€†á€€á€ºá€á€½á€šá€ºá€›á€”á€º á€¡á€á€»á€€á€ºá€¡á€œá€€á€ºá€™á€»á€¬á€¸á€€á€­á€¯ á€¡á€±á€¬á€„á€ºá€™á€¼á€„á€ºá€…á€½á€¬ á€•á€¼á€„á€ºá€†á€„á€ºá€•á€¼á€®á€¸á€•á€«á€•á€¼á€®á‹', 'success');
                // The onSnapshot listener will rerender the profile view
            } catch (error) {
                hideLoading();
                logStatus(`Contact Update Error: ${error.message}`, true);
                alertMessage('á€¡á€™á€¾á€¬á€¸', `á€•á€¼á€„á€ºá€†á€„á€ºá á€™á€›á€•á€«á‹ ${error.message}`, 'error');
            }
        }

        window.submitProfile = async function(event) {
            event.preventDefault();
            if (!currentUserId || !db) return alertMessage('á€¡á€™á€¾á€¬á€¸', 'á€…á€”á€…á€ºá€€á€­á€¯ á€…á€á€„á€ºá á€™á€›á€á€±á€¸á€•á€«á‹', 'error');

            const passportName = document.getElementById('passport-name').value;
            const phoneNumber = document.getElementById('phone-number').value.trim();
            const facebookLink = document.getElementById('facebook-link').value.trim();
            const telegramLink = document.getElementById('telegram-link').value.trim();
            const address = document.getElementById('address').value;

            if (!selectedPassportFile || !selectedUserPhotoFile) {
                return alertMessage('á€¡á€™á€¾á€¬á€¸', 'á€•á€á€ºá€…á€•á€­á€¯á€·á€•á€¯á€¶á€”á€¾á€„á€·á€º á€œá€°á€•á€¯á€¶á€€á€­á€¯ á€›á€½á€±á€¸á€á€»á€šá€ºá€›á€”á€º á€œá€­á€¯á€¡á€•á€ºá€•á€«á€á€Šá€ºá‹', 'error');
            }

            try {
                showLoading(); 
                logStatus("Starting profile image upload to Cloudinary...");

                // 1. Upload files concurrently
                const [passportUrl, userPhotoUrl] = await Promise.all([
                    uploadToCloudinary(selectedPassportFile),
                    uploadToCloudinary(selectedUserPhotoFile)
                ]);
                
                // 2. Prepare profile data with real URLs and new links
                const profileData = {
                    passportName: passportName,
                    thaiPhoneNumber: phoneNumber,
                    facebookLink: facebookLink,
                    telegramLink: telegramLink,
                    address: address,
                    passportPhotoUrl: passportUrl,
                    userPhotoUrl: userPhotoUrl,
                    status: 'pending', // Initial status is pending admin approval
                    timestamp: Date.now(),
                    email: currentUserEmail 
                };

                // 3a. Save to User's Private Profile
                const userDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`);
                await setDoc(userDocRef, profileData);
                
                // 3b. Save copy to Public Pending Collection for Admin visibility (using UID as doc ID)
                const pendingProfilesDocRef = doc(db, `artifacts/${appId}/public/data/pending_profiles`, currentUserId); 
                await setDoc(pendingProfilesDocRef, profileData);
                logStatus("Profile saved to private and public pending collections.");

                // Reset file state
                selectedPassportFile = null;
                selectedUserPhotoFile = null;

                hideLoading();
                alertMessage('á€á€„á€ºá€á€½á€„á€ºá€¸á€™á€¾á€¯ á€¡á€±á€¬á€„á€ºá€™á€¼á€„á€ºá€•á€«á€á€Šá€º', 'Admin á€á€½á€„á€·á€ºá€•á€¼á€¯á€á€»á€€á€ºá€¡á€á€½á€€á€º á€á€„á€ºáá€¡á€á€»á€€á€ºá€¡á€œá€€á€ºá€™á€»á€¬á€¸á€€á€­á€¯ á€•á€­á€¯á€·á€†á€±á€¬á€„á€ºá€•á€¼á€®á€¸á€•á€«á€•á€¼á€®á‹', 'success');
            } catch (error) {
                hideLoading();
                logStatus(`Profile Submission Error: ${error.message}`, true);
                alertMessage('á€¡á€™á€¾á€¬á€¸', `á€á€„á€ºá€á€½á€„á€ºá€¸á á€™á€›á€•á€«á‹ ${error.message}`, 'error');
            }
        }
        
        // Helper function to render the user's posted jobs (No change)
        function renderMyPostedJobs() {
            let jobsHtml = `<h3 class="text-lg font-semibold text-gray-800 mb-3 pt-4 border-t border-gray-200">á€á€„á€·á€ºá€™á€¾ á€á€„á€ºá€‘á€¬á€¸á€á€±á€¬ á€¡á€œá€¯á€•á€ºá€™á€»á€¬á€¸ (${myPostedJobsList.length} á€á€¯)</h3>`;
            
            if (myPostedJobsList.length === 0) {
                jobsHtml += '<p class="text-center text-gray-500 p-4 bg-gray-50 rounded-lg">á€á€„á€º á€á€„á€ºá€‘á€¬á€¸á€á€±á€¬ á€¡á€œá€¯á€•á€ºá€™á€»á€¬á€¸ á€™á€›á€¾á€­á€á€±á€¸á€•á€«á‹</p>';
                return jobsHtml;
            }

            myPostedJobsList.forEach(job => {
                 jobsHtml += `
                    <div class="bg-white p-3 mb-2 rounded-lg border border-indigo-100 shadow-sm">
                        <h4 class="font-semibold text-indigo-700">${job.title}</h4>
                        <p class="text-xs text-gray-600"><strong>ğŸ“ á€á€Šá€ºá€”á€±á€›á€¬:</strong> ${job.location}</p>
                        <p class="text-xs text-gray-600"><strong>ğŸ’µ á€œá€…á€¬:</strong> ${job.salaryMin} - ${job.salaryMax} á€˜á€á€º</p>
                        <p class="text-xs text-gray-600"><strong>ğŸ’¸ á€…á€™á€á€ºá€:</strong> ${job.smartFee || 0} á€˜á€á€º</p>
                    </div>
                `;
            });
            return jobsHtml;
        }

        // --- View 2B: Admin Panel (Updated to reflect new fields) ---
        function renderAdminPanel() {
            contentDiv.innerHTML = `
                <h2 class="text-xl font-bold mb-4 text-gray-800">Admin Panel</h2>
                <p class="mb-6 text-sm text-gray-600">á€¡á€®á€¸á€™á€±á€¸á€œá€º: ${ADMIN_EMAIL}</p>
                
                <!-- Send Notification Section (No change) -->
                <div class="bg-indigo-50 p-4 rounded-xl shadow-inner mb-6">
                    <h3 class="text-lg font-semibold text-indigo-700 mb-3 border-b border-indigo-200 pb-2">á€á€á€­á€•á€±á€¸á€á€»á€€á€º á€¡á€¬á€¸á€œá€¯á€¶á€¸á€á€­á€¯á€· á€•á€­á€¯á€·á€›á€”á€º</h3>
                    <form id="send-notification-form" class="space-y-3" onsubmit="sendNotification(event)">
                        <div>
                            <label for="notification-title" class="block text-sm font-medium text-gray-700">á€á€±á€«á€„á€ºá€¸á€…á€‰á€º</label>
                            <input type="text" id="notification-title" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 border p-2" placeholder="á€¥á€•á€™á€¬á‹ á€¡á€›á€±á€¸á€•á€±á€«á€º á€¡á€á€­á€•á€±á€¸á€á€»á€€á€º">
                        </div>
                        <div>
                            <label for="notification-content" class="block text-sm font-medium text-gray-700">á€…á€¬á€á€¬á€¸</label>
                            <textarea id="notification-content" rows="3" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 border p-2" placeholder="á€¡á€™á€»á€¬á€¸á€•á€¼á€Šá€ºá€á€°á€á€­á€¯á€· á€•á€±á€¸á€•á€­á€¯á€·á€œá€­á€¯á€á€±á€¬ á€…á€¬á€á€¬á€¸"></textarea>
                        </div>
                        <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 transition duration-150">
                            á€á€á€­á€•á€±á€¸á€á€»á€€á€º á€•á€­á€¯á€·á€›á€”á€º
                        </button>
                    </form>
                </div>

                <!-- User Approval Section -->
                <h3 class="text-lg font-semibold text-red-700 mb-3 border-b border-gray-200 pb-2">User á€á€½á€„á€·á€ºá€•á€¼á€¯á€á€»á€€á€º (Pending: ${pendingUsersList.length} á€¦á€¸)</h3>
            `;

            if (pendingUsersList.length === 0) {
                contentDiv.innerHTML += '<p class="text-center text-gray-500 mt-4 p-4 bg-green-50 rounded-lg">á€á€½á€„á€·á€ºá€•á€¼á€¯á€›á€”á€º á€…á€±á€¬á€„á€·á€ºá€†á€­á€¯á€„á€ºá€¸á€”á€±á€á€±á€¬ User á€™á€›á€¾á€­á€•á€«á‹</p>';
                return;
            }

            pendingUsersList.forEach(user => {
                const userCard = `
                    <div class="bg-yellow-50 p-4 mb-3 rounded-lg border border-yellow-200 shadow-sm">
                        <p class="font-bold text-gray-800">${user.passportName || 'á€¡á€™á€Šá€ºá€™á€–á€±á€¬á€ºá€•á€¼á€‘á€¬á€¸á€•á€«'}</p>
                        <p class="text-sm text-gray-700"><strong>á€¡á€®á€¸á€™á€±á€¸á€œá€º:</strong> ${user.email}</p>
                        <p class="text-sm text-gray-700"><strong>UID:</strong> ${user.uid.substring(0, 8)}...</p>
                        <p class="text-sm text-gray-700"><strong>á€–á€¯á€”á€ºá€¸:</strong> ${user.thaiPhoneNumber}</p>
                        <p class="text-sm text-gray-700"><strong>FB:</strong> ${user.facebookLink || 'á€™á€›á€¾á€­á€•á€«'}</p>
                        <p class="text-sm text-gray-700"><strong>TG:</strong> ${user.telegramLink || 'á€™á€›á€¾á€­á€•á€«'}</p>
                        <p class="text-sm text-gray-700 mb-2"><strong>á€œá€­á€•á€ºá€…á€¬:</strong> ${user.address}</p>
                        
                        <div class="grid grid-cols-2 gap-4 pt-2 mb-3">
                            ${user.passportPhotoUrl ? `<img src="${user.passportPhotoUrl}" onerror="this.onerror=null;this.src='https://placehold.co/100x64/9ca3af/ffffff?text=Passport%20Photo'" alt="Passport Photo" class="w-full h-16 object-cover rounded-lg">` : '<div class="text-center text-xs text-gray-500 bg-gray-200 p-2 rounded-lg">Passport Photo N/A</div>'}
                            ${user.userPhotoUrl ? `<img src="${user.userPhotoUrl}" onerror="this.onerror=null;this.src='https://placehold.co/100x64/9ca3af/ffffff?text=User%20Photo'" alt="User Photo" class="w-full h-16 object-cover rounded-lg">` : '<div class="text-center text-xs text-gray-500 bg-gray-200 p-2 rounded-lg">User Photo N/A</div>'}
                        </div>

                        <button onclick="approveUser('${user.uid}')" class="w-full bg-green-600 text-white py-2 rounded-lg text-sm hover:bg-green-700 transition duration-150 mt-2">
                            á€¤ User á€€á€­á€¯ á€á€½á€„á€·á€ºá€•á€¼á€¯á€›á€”á€º
                        </button>
                    </div>
                `;
                contentDiv.innerHTML += userCard;
            });
        }

        window.sendNotification = async function(event) {
            event.preventDefault();
            if (!isUserAdmin || !db) return alertMessage('á€¡á€™á€¾á€¬á€¸', 'Admin á€¡á€–á€¼á€…á€º á€á€„á€ºá€›á€±á€¬á€€á€ºá€‘á€¬á€¸á€›á€•á€«á€™á€Šá€ºá‹', 'error');

            const title = document.getElementById('notification-title').value;
            const content = document.getElementById('notification-content').value;

            if (!title || !content) {
                return alertMessage('á€¡á€™á€¾á€¬á€¸', 'á€á€±á€«á€„á€ºá€¸á€…á€‰á€ºá€”á€¾á€„á€·á€º á€…á€¬á€á€¬á€¸á€€á€­á€¯ á€–á€¼á€Šá€·á€ºá€á€½á€„á€ºá€¸á€›á€”á€º á€œá€­á€¯á€¡á€•á€ºá€•á€«á€á€Šá€ºá‹', 'error');
            }

            try {
                const collectionRef = collection(db, `artifacts/${appId}/public/data/notifications`);
                await addDoc(collectionRef, {
                    title: title,
                    content: content,
                    sentBy: currentUserEmail,
                    timestamp: Date.now()
                });
                
                document.getElementById('send-notification-form').reset();
                alertMessage('á€•á€­á€¯á€·á€†á€±á€¬á€„á€ºá€™á€¾á€¯ á€¡á€±á€¬á€„á€ºá€™á€¼á€„á€º', 'á€á€á€­á€•á€±á€¸á€á€»á€€á€ºá€€á€­á€¯ á€¡á€™á€»á€¬á€¸á€•á€¼á€Šá€ºá€á€°á€á€­á€¯á€· á€¡á€±á€¬á€„á€ºá€™á€¼á€„á€ºá€…á€½á€¬ á€•á€­á€¯á€·á€œá€­á€¯á€€á€ºá€•á€«á€•á€¼á€®á‹', 'success');
            } catch (error) {
                logStatus(`Send Notification Error: ${error.message}`, true);
                alertMessage('á€¡á€™á€¾á€¬á€¸', `á€á€á€­á€•á€±á€¸á€á€»á€€á€º á€•á€­á€¯á€·á á€™á€›á€•á€«á‹: ${error.message}`, 'error');
            }
        }

        window.approveUser = async function(userIdToApprove) {
            if (!isUserAdmin || !db) return alertMessage('á€¡á€™á€¾á€¬á€¸', 'Admin á€¡á€–á€¼á€…á€º á€á€„á€ºá€›á€±á€¬á€€á€ºá€‘á€¬á€¸á€›á€•á€«á€™á€Šá€ºá‹', 'error');
            
            // Fetch the user's current pending data (includes phone, fb, tg, etc.)
            const pendingDocRef = doc(db, `artifacts/${appId}/public/data/pending_profiles`, userIdToApprove);
            const pendingSnap = await getDoc(pendingDocRef);
            
            if (!pendingSnap.exists()) {
                return alertMessage('á€¡á€™á€¾á€¬á€¸', 'á€á€½á€„á€·á€ºá€•á€¼á€¯á€›á€”á€º User á á€¡á€á€»á€€á€ºá€¡á€œá€€á€ºá€™á€»á€¬á€¸á€€á€­á€¯ á€›á€¾á€¬á€™á€á€½á€±á€·á€•á€«á‹', 'error');
            }
            
            const userData = pendingSnap.data();

            try {
                // 1. Update the user's private profile status
                const userDocRef = doc(db, `artifacts/${appId}/users/${userIdToApprove}/profile/data`);
                await updateDoc(userDocRef, { status: 'approved' });
                
                // 2. NEW: Save Public Contact Info for job seekers (use data from pending profile)
                const publicContactRef = doc(db, `artifacts/${appId}/public/data/public_contacts`, userIdToApprove);
                await setDoc(publicContactRef, {
                    thaiPhoneNumber: userData.thaiPhoneNumber || '',
                    facebookLink: userData.facebookLink || '',
                    telegramLink: userData.telegramLink || ''
                });
                
                // 3. Delete the public pending profile document
                await deleteDoc(pendingDocRef);
                
                alertMessage('á€á€½á€„á€·á€ºá€•á€¼á€¯á€á€»á€€á€º á€¡á€±á€¬á€„á€ºá€™á€¼á€„á€º', `User ID: ${userIdToApprove.substring(0, 8)} á€€á€­á€¯ á€¡á€±á€¬á€„á€ºá€™á€¼á€„á€ºá€…á€½á€¬ á€á€½á€„á€·á€ºá€•á€¼á€¯á€œá€­á€¯á€€á€ºá€•á€«á€•á€¼á€®á‹`, 'success');
            } catch (error) {
                logStatus(`Admin Approval Error: ${error.message}`, true);
                alertMessage('á€¡á€™á€¾á€¬á€¸', `á€á€½á€„á€·á€ºá€•á€¼á€¯á€á€»á€€á€º á€•á€±á€¸á á€™á€›á€•á€«á‹: ${error.message}`, 'error');
            }
        }
        
        // --- View 4: Notifications Inbox (No change) ---
        
        function renderNotifications() {
            contentDiv.innerHTML = `
                <h2 class="text-xl font-bold mb-4 text-gray-800">á€á€á€­á€•á€±á€¸á€á€»á€€á€ºá€™á€»á€¬á€¸ (Admin á€™á€¾ á€•á€±á€¸á€•á€­á€¯á€·á€á€Šá€º)</h2>
                ${window.notificationsList && window.notificationsList.length > 0 ? '' : '<p class="text-center text-gray-500 mt-10 p-4 bg-gray-100 rounded-lg">á€œá€€á€ºá€á€¶á€›á€›á€¾á€­á€‘á€¬á€¸á€á€±á€¬ á€á€á€­á€•á€±á€¸á€á€»á€€á€ºá€™á€»á€¬á€¸ á€™á€›á€¾á€­á€á€±á€¸á€•á€«á‹</p>'}
                <div id="notifications-list" class="space-y-4"></div>
            `;
            
            const listDiv = document.getElementById('notifications-list');
            
            if(window.notificationsList) {
                window.notificationsList.forEach(noti => {
                    const date = new Date(noti.timestamp).toLocaleString('my-MM', {
                        year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                    });
                    
                    const notiCard = `
                        <div class="bg-white p-4 rounded-xl shadow-md border border-indigo-100">
                            <h3 class="text-lg font-semibold text-indigo-700">${noti.title}</h3>
                            <p class="text-xs text-gray-500 mb-2">
                                <span class="font-medium text-gray-600">Admin</span> 
                                <span class="ml-2">| ${date}</span>
                            </p>
                            <p class="text-gray-700 whitespace-pre-wrap">${noti.content}</p>
                        </div>
                    `;
                    listDiv.innerHTML += notiCard;
                });
            }
        }


        // --- View 3: Post Job Form (Updated to use Job Smart Fee) ---

        window.handleJobMediaChange = function(event, type) {
            const files = Array.from(event.target.files);
            const statusElement = document.getElementById(`job-${type}-status`);
            
            if (type === 'images') {
                if (files.length > 3) {
                    alertMessage('á€¡á€™á€¾á€¬á€¸', 'á€“á€¬á€á€ºá€•á€¯á€¶ áƒ á€•á€¯á€¶á€¡á€‘á€­á€á€¬ á€á€„á€ºá€”á€­á€¯á€„á€ºá€•á€«á€á€Šá€ºá‹', 'error');
                    event.target.value = ''; // Clear selection
                    selectedJobImages = [];
                    statusElement.textContent = 'áƒ á€•á€¯á€¶á€¡á€‘á€­á€á€¬ á€›á€½á€±á€¸á€á€»á€šá€ºá€”á€­á€¯á€„á€ºá€•á€«á€á€Šá€ºá‹';
                    return;
                }
                selectedJobImages = files;
                statusElement.textContent = `á€›á€½á€±á€¸á€á€»á€šá€ºá€‘á€¬á€¸á€á€±á€¬ á€•á€¯á€¶á€™á€»á€¬á€¸: ${files.length} á€•á€¯á€¶ (${files.map(f => f.name).join(', ')})`;
            } else if (type === 'video') {
                if (files.length > 1) {
                    alertMessage('á€¡á€™á€¾á€¬á€¸', 'á€—á€®á€’á€®á€šá€­á€¯ á á€á€¯á€á€¬ á€á€„á€ºá€”á€­á€¯á€„á€ºá€•á€«á€á€Šá€ºá‹', 'error');
                    event.target.value = '';
                    selectedJobVideo = null;
                    statusElement.textContent = 'á€—á€®á€’á€®á€šá€­á€¯ á á€á€¯á€á€¬ á€›á€½á€±á€¸á€á€»á€šá€ºá€”á€­á€¯á€„á€ºá€•á€«á€á€Šá€ºá‹';
                    return;
                }
                selectedJobVideo = files[0] || null;
                statusElement.textContent = selectedJobVideo ? `á€›á€½á€±á€¸á€á€»á€šá€ºá€•á€¼á€®á€¸: ${selectedJobVideo.name}` : '';
            }
        }

        function renderJobPostForm() {
            logStatus("Attempting to render Job Post Form...");
            
            try {
                if (!currentUserProfile || currentUserProfile.status !== 'approved') {
                    logStatus("Job Post Form redirecting to Profile: User not approved.", true);
                    return renderRegistrationProfile(); 
                }

                const posterName = currentUserProfile.passportName || currentUserEmail;

                contentDiv.innerHTML = `
                    <h2 class="text-xl font-bold mb-4 text-gray-800">á€¡á€œá€¯á€•á€ºá€á€…á€ºá€á€„á€ºá€›á€”á€º</h2>
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <form id="job-post-form" class="space-y-4" onsubmit="submitJobPost(event)">
                            
                            <!-- Poster Info (Read-only) -->
                            <div class="bg-gray-100 p-3 rounded-lg">
                                <label class="block text-sm font-semibold text-gray-700">á€á€„á€ºá€á€°áá€”á€¬á€™á€Šá€º</label>
                                <p class="text-sm text-gray-600">${posterName}</p>
                            </div>
                            
                            <!-- Job Title -->
                            <div>
                                <label for="job-title" class="block text-sm font-medium text-gray-700">á€¡á€œá€¯á€•á€ºá€¡á€™á€Šá€º</label>
                                <input type="text" id="job-title" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 border p-2">
                            </div>
                            
                            <!-- Job Location -->
                            <div>
                                <label for="job-location" class="block text-sm font-medium text-gray-700">á€¡á€œá€¯á€•á€ºá€á€Šá€ºá€”á€±á€›á€¬</label>
                                <input type="text" id="job-location" required placeholder="á€¥á€•á€™á€¬á‹ á€˜á€”á€ºá€€á€±á€¬á€€á€ºáŠ á€á€»á€„á€ºá€¸á€™á€­á€¯á€„á€º" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 border p-2">
                            </div>
                            
                            <!-- NEW: Job Smart Fee -->
                            <div>
                                <label for="job-smart-fee" class="block text-sm font-medium text-gray-700">ğŸ’¸ á€¡á€œá€¯á€•á€ºá€…á€™á€á€ºá€ (á€˜á€á€º)</label>
                                <input type="number" id="job-smart-fee" required placeholder="á€¥á€•á€™á€¬á‹ 1000 (á€˜á€á€º)" min="0" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 border p-2">
                            </div>

                            <!-- Salary Smart Card (Number Inputs) -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700">ğŸ’µ á€œá€…á€¬ (á€˜á€á€º)</label>
                                <div class="grid grid-cols-2 gap-2 mt-1">
                                    <input type="number" id="salary-min" required placeholder="á€¡á€”á€­á€™á€·á€ºá€†á€¯á€¶á€¸" min="0" class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 border p-2">
                                    <input type="number" id="salary-max" required placeholder="á€¡á€™á€¼á€„á€·á€ºá€†á€¯á€¶á€¸" min="0" class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 border p-2">
                                </div>
                            </div>

                            <!-- Job Description -->
                            <div>
                                <label for="job-description" class="block text-sm font-medium text-gray-700">á€¡á€œá€¯á€•á€ºá€¡á€€á€¼á€±á€¬á€„á€ºá€¸á€¡á€›á€¬/á€¡á€á€±á€¸á€…á€­á€á€º</label>
                                <textarea id="job-description" rows="5" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 border p-2"></textarea>
                            </div>
                            
                            <!-- Media Uploads (No change) -->
                            <div class="pt-2 border-t">
                                <label class="block text-sm font-semibold text-gray-800 mb-2">á€“á€¬á€á€ºá€•á€¯á€¶ áƒ á€•á€¯á€¶ á€”á€¾á€„á€·á€º á€—á€®á€’á€®á€šá€­á€¯ á á€á€¯ (Cloudinary Upload)</label>
                                <div class="space-y-3">
                                    <!-- Images -->
                                    <div>
                                        <label for="job-images-file" class="block text-xs font-medium text-gray-600 mb-1">á€¡á€œá€¯á€•á€º á€“á€¬á€á€ºá€•á€¯á€¶á€™á€»á€¬á€¸ (á€¡á€™á€»á€¬á€¸á€†á€¯á€¶á€¸ áƒ á€•á€¯á€¶)</label>
                                        <input type="file" id="job-images-file" accept="image/*" multiple 
                                            onchange="handleJobMediaChange(event, 'images')" 
                                            class="w-full text-sm text-gray-500 border border-gray-300 rounded-lg p-1">
                                        <p id="job-images-status" class="text-xs text-gray-500 mt-1 text-indigo-600">á€¡á€”á€Šá€ºá€¸á€†á€¯á€¶á€¸ á á€•á€¯á€¶ á€œá€­á€¯á€¡á€•á€ºá€•á€«á€á€Šá€ºá‹</p>
                                    </div>
                                    <!-- Video -->
                                    <div>
                                        <label for="job-video-file" class="block text-xs font-medium text-gray-600 mb-1">á€¡á€œá€¯á€•á€º á€—á€®á€’á€®á€šá€­á€¯ (á á€á€¯)</label>
                                        <input type="file" id="job-video-file" accept="video/*" 
                                            onchange="handleJobMediaChange(event, 'video')" 
                                            class="w-full text-sm text-gray-500 border border-gray-300 rounded-lg p-1">
                                        <p id="job-video-status" class="text-xs text-gray-500 mt-1 text-indigo-600"></p>
                                    </div>
                                </div>
                            </div>

                            <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-md text-base font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 mt-6">
                                á€¡á€œá€¯á€•á€ºá€á€„á€ºá€›á€”á€º
                            </button>
                        </form>
                    </div>
                `;
                logStatus("Successfully rendered Job Post Form.");
            } catch (error) {
                logStatus(`Job Post Render Failed CRITICALLY: ${error.message}`, true);
                contentDiv.innerHTML = `
                    <div class="text-red-500 text-center p-8 bg-red-50 rounded-lg border border-red-200 mt-10">
                        <h3 class="font-bold text-lg mb-2">á€™á€¼á€„á€ºá€€á€½á€„á€ºá€¸á€•á€¼á€›á€¬á€á€½á€„á€º á€¡á€›á€±á€¸á€€á€¼á€®á€¸á€á€±á€¬ á€¡á€™á€¾á€¬á€¸á€–á€¼á€…á€ºá€•á€½á€¬á€¸á€•á€«á€á€Šá€ºá‹</h3>
                        <p class="text-sm">á€¡á€™á€¾á€¬á€¸: ${error.message}</p>
                        <p class="text-xs mt-2">Console (Log) á€á€½á€„á€º á€¡á€á€±á€¸á€…á€­á€á€ºá€€á€­á€¯ á€…á€…á€ºá€†á€±á€¸á€•á€«á‹</p>
                    </div>
                `;
            }
        }
        
        window.submitJobPost = async function(event) {
            event.preventDefault();
            if (!currentUserId || !db) return alertMessage('á€¡á€™á€¾á€¬á€¸', 'á€…á€”á€…á€ºá€€á€­á€¯ á€…á€á€„á€ºá á€™á€›á€á€±á€¸á€•á€«á‹', 'error');
            
            // Input Validation & Parsing
            const title = document.getElementById('job-title').value;
            const jobLocation = document.getElementById('job-location').value;
            const smartFeeInput = document.getElementById('job-smart-fee').value; // NEW
            const salaryMinInput = document.getElementById('salary-min').value;
            const salaryMaxInput = document.getElementById('salary-max').value;
            const description = document.getElementById('job-description').value;

            if (!salaryMinInput || !salaryMaxInput || !smartFeeInput) {
                return alertMessage('á€¡á€™á€¾á€¬á€¸', 'á€œá€…á€¬á€”á€¾á€„á€·á€º á€¡á€œá€¯á€•á€ºá€…á€™á€á€ºá€á€á€­á€¯á€·á€€á€­á€¯ á€–á€¼á€Šá€·á€ºá€á€½á€„á€ºá€¸á€›á€”á€º á€œá€­á€¯á€¡á€•á€ºá€•á€«á€á€Šá€ºá‹', 'error');
            }

            const salaryMin = parseInt(salaryMinInput);
            const salaryMax = parseInt(salaryMaxInput);
            const smartFee = parseInt(smartFeeInput); // NEW


            if (isNaN(salaryMin) || isNaN(salaryMax) || salaryMin < 0 || salaryMax < 0 || salaryMin > salaryMax) {
                return alertMessage('á€¡á€™á€¾á€¬á€¸', 'á€œá€…á€¬á€á€Šá€º á€™á€¾á€”á€ºá€€á€”á€ºá€á€±á€¬ á€‚á€á€”á€ºá€¸á€–á€¼á€…á€ºá€›á€™á€Šá€ºá‹ (á€¡á€”á€­á€™á€·á€ºá€†á€¯á€¶á€¸á€á€Šá€º á€¡á€™á€¼á€„á€·á€ºá€†á€¯á€¶á€¸á€‘á€€á€º á€™á€•á€­á€¯á€›á‹)', 'error');
            }
            if (isNaN(smartFee) || smartFee < 0) {
                 return alertMessage('á€¡á€™á€¾á€¬á€¸', 'á€¡á€œá€¯á€•á€ºá€…á€™á€á€ºá€á€á€Šá€º á€™á€¾á€”á€ºá€€á€”á€ºá€á€±á€¬ á€‚á€á€”á€ºá€¸ (á€˜á€á€º) á€–á€¼á€…á€ºá€›á€•á€«á€™á€Šá€ºá‹', 'error');
            }
            if (selectedJobImages.length === 0) {
                return alertMessage('á€¡á€™á€¾á€¬á€¸', 'á€¡á€œá€¯á€•á€ºá€“á€¬á€á€ºá€•á€¯á€¶ á€¡á€”á€Šá€ºá€¸á€†á€¯á€¶á€¸ á€á€…á€ºá€•á€¯á€¶ á€›á€½á€±á€¸á€á€»á€šá€ºá€›á€”á€º á€œá€­á€¯á€¡á€•á€ºá€•á€«á€á€Šá€ºá‹', 'error');
            }

            try {
                showLoading();
                logStatus("Starting job media upload to Cloudinary...");

                // 1. Upload images concurrently
                const imageUploadPromises = selectedJobImages.map(file => uploadToCloudinary(file));
                const uploadedImageUrls = await Promise.all(imageUploadPromises);
                
                // 2. Upload video (if selected)
                let uploadedVideoUrl = null;
                if (selectedJobVideo) {
                    uploadedVideoUrl = await uploadToCloudinary(selectedJobVideo);
                }
                
                // 3. Prepare job data with real URLs and new fields
                const jobData = {
                    title: title,
                    location: jobLocation,
                    smartFee: smartFee, // NEW: Smart Fee added
                    salaryMin: salaryMin,
                    salaryMax: salaryMax,
                    description: description,
                    media: {
                        images: uploadedImageUrls.filter(url => url), 
                        video: uploadedVideoUrl
                    },
                    postedBy: currentUserId,
                    postedByName: currentUserProfile?.passportName || currentUserEmail,
                    status: 'approved', 
                    timestamp: Date.now()
                };

                // 4. Save to Firestore
                const collectionRef = collection(db, `artifacts/${appId}/public/data/jobs`);
                const newDocRef = await addDoc(collectionRef, jobData);
                logStatus(`Job saved to Firestore: ${newDocRef.id}`);
                
                // 5. Reset file state and form elements
                selectedJobImages = [];
                selectedJobVideo = null;
                document.getElementById('job-post-form').reset();
                // Explicitly reset file inputs and status messages
                document.getElementById('job-images-file').value = ''; 
                document.getElementById('job-video-file').value = ''; 
                document.getElementById('job-images-status').textContent = 'á€¡á€”á€Šá€ºá€¸á€†á€¯á€¶á€¸ á á€•á€¯á€¶ á€œá€­á€¯á€¡á€•á€ºá€•á€«á€á€Šá€ºá‹';
                document.getElementById('job-video-status').textContent = '';
                
                hideLoading();
                alertMessage('á€¡á€œá€¯á€•á€ºá€á€„á€ºá€á€¼á€„á€ºá€¸ á€¡á€±á€¬á€„á€ºá€™á€¼á€„á€ºá€•á€«á€á€Šá€º', `á€¡á€œá€¯á€•á€ºá€¡á€á€…á€ºá€€á€­á€¯ Home á€…á€¬á€™á€»á€€á€ºá€”á€¾á€¬á€á€½á€„á€º á€á€»á€€á€ºá€á€»á€„á€ºá€¸ á€™á€¼á€„á€ºá€”á€­á€¯á€„á€ºá€•á€«á€•á€¼á€®á‹ (ID: ${newDocRef.id})`, 'success');
                setView('home'); 
            } catch (error) {
                hideLoading();
                logStatus(`Job Post Submission Error: ${error.message}`, true);
                alertMessage('á€¡á€™á€¾á€¬á€¸', `á€¡á€œá€¯á€•á€ºá€á€„á€ºá á€™á€›á€•á€«á‹: ${error.message}`, 'error');
            }
        }
        
        // --- Custom Alert/Modal (Updated for Contact Info Modal) ---
        
        function alertMessage(title, message, type = 'info') {
            const modalId = 'custom-alert-modal';
            let modal = document.getElementById(modalId);
            if (!modal) {
                modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 flex justify-center items-center z-50 p-4 hidden';
                modal.id = modalId;
                document.body.appendChild(modal);
            }
            
            modal.querySelector('.modal-content')?.remove(); // Remove previous content if contact modal was used

            let bgColor = 'bg-indigo-100';
            let titleColor = 'text-indigo-800';
            let icon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>`;

            if (type === 'success') {
                bgColor = 'bg-green-100';
                titleColor = 'text-green-800';
                icon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>`;
            } else if (type === 'error') {
                bgColor = 'bg-red-100';
                titleColor = 'text-red-800';
                icon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>`;
            }

            const alertHtml = `
                <div class="modal-content bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm transform transition-all">
                    <div class="flex items-center ${bgColor} p-3 rounded-lg mb-4">
                        <div class="${titleColor} mr-3">${icon}</div>
                        <h3 class="text-lg font-bold ${titleColor}">${title}</h3>
                    </div>
                    <p class="text-gray-700 mb-6">${message}</p>
                    <button onclick="document.getElementById('${modalId}').classList.add('hidden')"
                            class="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 transition duration-150">
                        á€”á€¬á€¸á€œá€Šá€ºá€•á€«á€•á€¼á€®
                    </button>
                </div>
            `;
            modal.innerHTML = alertHtml;
            modal.classList.remove('hidden');
        }
        
        // NEW: Dedicated function for Contact Modal
        function showCustomModal(title, contentHtml, type) {
            const modalId = 'custom-alert-modal';
            let modal = document.getElementById(modalId);
            if (!modal) {
                modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 flex justify-center items-center z-50 p-4 hidden';
                modal.id = modalId;
                document.body.appendChild(modal);
            }
            
            let icon;
            if (type === 'contact') {
                 icon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-3"/><path d="m6 16-2 6"/><path d="m14 16-2 6"/><path d="M16 2a2 2 0 0 1 2 2v7a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2z"/></svg>`;
            }

            const modalHtml = `
                <div class="modal-content bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm transform transition-all">
                    <div class="flex items-center bg-indigo-100 p-3 rounded-lg mb-4">
                        <div class="text-indigo-800 mr-3">${icon}</div>
                        <h3 class="text-lg font-bold text-indigo-800">${title}</h3>
                    </div>
                    ${contentHtml}
                    <button onclick="document.getElementById('${modalId}').classList.add('hidden')"
                            class="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 transition duration-150 mt-6">
                        á€•á€­á€á€ºá€™á€Šá€º
                    </button>
                </div>
            `;
            modal.innerHTML = modalHtml;
            modal.classList.remove('hidden');
        }


        // --- Start the application ---
        initFirebase();

    </script>
</body>
</html>
